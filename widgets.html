<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Phase Space Heatmap</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>

<div id="sliders" style="margin-bottom:10px;">
  c: <input id="cSlider" type="range" min="0.1" max="1.5" step="0.05" value="0.4">
  <span id="cVal">0.4</span>
  e: <input id="eSlider" type="range" min="0.1" max="1.5" step="0.05" value="0.4">
  <span id="eVal">0.4</span><br>
  m: <input id="mSlider" type="range" min="0.1" max="1.5" step="0.05" value="0.2">
  <span id="mVal">0.2</span>
  d: <input id="dSlider" type="range" min="0.1" max="1.5" step="0.05" value="0.5">
  <span id="dVal">0.5</span>
</div>

<div id="heatmap"></div>

<script>
const T = 1.0, EPS = 1e-9, N_POINTS = 150;
const x = Array.from({length: N_POINTS}, (_, i) => i / (N_POINTS - 1));
const y = Array.from({length: N_POINTS}, (_, i) => i / (N_POINTS - 1));

function eig2x2(A,B,C,D){
  const tr = A + D, det = A*D - B*C;
  const disc = Math.max(tr*tr - 4*det, 0);
  const λ1 = 0.5*(tr + Math.sqrt(disc));
  const λ2 = 0.5*(tr - Math.sqrt(disc));
  const v1 = [1, (λ1 - A)/B];
  const v2 = [1, (λ2 - A)/B];
  return {λ1, λ2, v1, v2};
}

function analyze(c,e,m,d,Ni0,Nm0){
  if(Ni0 + Nm0 > T + EPS) return 5;
  const A = -(e+m+c), B = d-c, C = m, D = -d;
  const {λ1,λ2,v1,v2} = eig2x2(A,B,C,D);
  if(!isFinite(v1[1]) || !isFinite(v2[1])) return 5;
  const v12 = v1[1], v22 = v2[1];
  const W1 = 1 + v12, W2 = 1 + v22;
  const detADBC = A*D - B*C;
  if(Math.abs(detADBC)<EPS) return 5;
  const k1 = -(c*T*D)/detADBC;
  const k2 = -(c*T*C)/detADBC;
  const s0k1 = Ni0 - k1, s0k2 = Nm0 - k2;
  const detV = v12 - v22;
  if(Math.abs(detV)<EPS) return 5;
  const c1 = (s0k2 - v22*s0k1)/detV;
  const c2 = (v12*s0k1 - s0k2)/detV;
  const S0 = λ1*c1*W1 + λ2*c2*W2;
  const denom = λ1*c1*W1;
  let κ = -1;
  if(Math.abs(denom)>EPS) κ = (-λ2*c2*W2)/denom;
  const ext = κ > 1 + EPS;
  if(ext){
    if(S0>EPS) return 2; // local max
    if(S0<-EPS) return 4; // local min
  }
  if(S0>EPS) return 1;
  if(S0<-EPS) return 3;
  const ss = k1 + k2;
  return (Ni0 + Nm0 > ss + EPS) ? 3 : 1;
}

function compute(c,e,m,d){
  const Z = Array.from({length:N_POINTS}, ()=>Array(N_POINTS).fill(0));
  for(let i=0;i<N_POINTS;i++){
    for(let j=0;j<N_POINTS;j++){
      Z[i][j] = analyze(c,e,m,d,x[j],y[i]);
    }
  }
  return Z;
}

function update(){
  const c=parseFloat(cSlider.value), e=parseFloat(eSlider.value),
        m=parseFloat(mSlider.value), d=parseFloat(dSlider.value);
  cVal.textContent=c.toFixed(2);
  eVal.textContent=e.toFixed(2);
  mVal.textContent=m.toFixed(2);
  dVal.textContent=d.toFixed(2);
  const Z=compute(c,e,m,d);
  const colors=['#1b9e77','#d95f02','#e7298a','#7570b3','#cccccc'];
  const trace={x:x, y:y, z:Z, type:'heatmap',
    colorscale: colors.map((c,i)=>[i/4,c]),
    zmin:1, zmax:5, showscale:false};
  const line={x:[0,1], y:[1,0], mode:'lines', line:{color:'black',dash:'dash'}};
  Plotly.newPlot('heatmap',[trace,line],{
    xaxis:{title:'N_I(0)',range:[0,1]},
    yaxis:{title:'N_M(0)',range:[0,1]},
    title:`Phase space for c=${c}, e=${e}, m=${m}, d=${d}`,
    width:600, height:600
  });
}

[cSlider,eSlider,mSlider,dSlider].forEach(sl=>sl.addEventListener('input',update));
update();
</script>
</body>
</html>
