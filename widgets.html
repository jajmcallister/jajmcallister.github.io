<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Synapse Dynamics Widgets</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
body { font-family: sans-serif; margin: 20px; }
.slider-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
.slider-box { flex: 1 1 200px; }
h2 { margin-top: 40px; }
</style>
</head>
<body>

<h1>Interactive Synapse Dynamics</h1>

<!-- Shared sliders -->
<div class="slider-container">
  <div class="slider-box"><label>c (creation): <input type="range" id="c" min="0.1" max="1.5" step="0.05" value="0.4"><span id="c_val">0.4</span></label></div>
  <div class="slider-box"><label>e (elimination): <input type="range" id="e" min="0.1" max="1.5" step="0.05" value="0.4"><span id="e_val">0.4</span></label></div>
  <div class="slider-box"><label>m (maturation): <input type="range" id="m" min="0.1" max="1.5" step="0.05" value="0.2"><span id="m_val">0.2</span></label></div>
  <div class="slider-box"><label>d (decay): <input type="range" id="d" min="0.1" max="1.5" step="0.05" value="0.5"><span id="d_val">0.5</span></label></div>
  <div class="slider-box"><label>Ni₀: <input type="range" id="Ni0" min="0" max="1" step="0.01" value="0"><span id="Ni0_val">0</span></label></div>
  <div class="slider-box"><label>Nm₀: <input type="range" id="Nm0" min="0" max="1" step="0.01" value="0"><span id="Nm0_val">0</span></label></div>
</div>

<h2>1. Phase Space Regions</h2>
<div id="phase_plot" style="width:700px;height:700px;"></div>

<h2>2. Time Series</h2>
<div id="time_plot" style="width:900px;height:600px;"></div>

<script>
// ======== Core model ==========
const T = 1.0, EPS = 1e-9;

function analyzeExtrema(c,e,m,d,Ni0,Nm0){
  if(Ni0 + Nm0 > T + EPS) return 5;
  const A = -(e+m+c), B = d-c, C = m, D = -d;
  const tr = A + D, det = A*D - B*C;
  const disc = Math.max(tr*tr - 4*det,0);
  const lambda1 = 0.5*(tr + Math.sqrt(disc));
  const lambda2 = 0.5*(tr - Math.sqrt(disc));
  const v1 = [1, (lambda1 - A)/B];
  const v2 = [1, (lambda2 - A)/B];
  const v12=v1[1], v22=v2[1], W1=1+v12, W2=1+v22;
  const k1 = (c*T*D)/(A*D - B*C);
  const k2 = (c*T*C)/(A*D - B*C);
  const s0k = [Ni0-k1, Nm0-k2];
  const detV = (v12 - v22);
  if(Math.abs(detV)<EPS) return 5;
  const c1 = (s0k[1]-v22*s0k[0])/(v12 - v22);
  const c2 = (v12*s0k[0]-s0k[1])/(v12 - v22);
  const S0 = lambda1*c1*W1 + lambda2*c2*W2;
  const denom = lambda1*c1*W1;
  let kappa = -1;
  if(Math.abs(denom)>EPS) kappa = (-lambda2*c2*W2)/denom;
  const ext_tgt = kappa>1+EPS;
  if(ext_tgt){
    if(S0>EPS) return 2;
    if(S0<-EPS) return 4;
  }
  if(S0>EPS) return 1;
  if(S0<-EPS) return 3;
  return 1;
}

// ======== Phase space plot ==========
function makePhasePlot(c,e,m,d){
  const N=60;
  const x=Array.from({length:N},(_,i)=>i/(N-1));
  const y=Array.from({length:N},(_,i)=>i/(N-1));
  const Z=[];
  for(let j=0;j<N;j++){
    const row=[];
    for(let i=0;i<N;i++){
      row.push(analyzeExtrema(c,e,m,d,x[i],y[j]));
    }
    Z.push(row);
  }
  const data=[{
    z:Z, x:x, y:y, type:'heatmap',
    colorscale:[[0,'#1b9e77'],[0.25,'#d95f02'],[0.5,'#e7298a'],[0.75,'#7570b3'],[1,'#cccccc']],
    showscale:false
  },{
    x:[0,T], y:[T,0], mode:'lines', line:{dash:'dash',color:'black'}, name:'N_I+N_M=T'
  }];
  const layout={xaxis:{title:'N_I(0)',range:[0,T]},yaxis:{title:'N_M(0)',range:[0,T]},
                title:`Phase space (c=${c.toFixed(2)}, e=${e.toFixed(2)}, m=${m.toFixed(2)}, d=${d.toFixed(2)})`,
                width:700,height:700,margin:{l:60,r:10,b:50,t:50}};
  Plotly.newPlot('phase_plot',data,layout);
}

// ======== Time-series plot ==========
function solveODE(c,e,m,d,Ni0,Nm0){
  const A=-(e+m+c), B=d-c, C=m, D=-d;
  const tr=A+D, det=A*D - B*C;
  const disc=Math.max(tr*tr - 4*det,0);
  const lambda1=0.5*(tr+Math.sqrt(disc));
  const lambda2=0.5*(tr-Math.sqrt(disc));
  const v12=(lambda1-A)/B, v22=(lambda2-A)/B;
  const k1=(c*T*D)/(A*D - B*C);
  const k2=(c*T*C)/(A*D - B*C);
  const detV=(v12 - v22);
  const s0k=[Ni0-k1, Nm0-k2];
  const c1=(s0k[1]-v22*s0k[0])/(v12 - v22);
  const c2=(v12*s0k[0]-s0k[1])/(v12 - v22);
  const tmax=50, N=400, dt=tmax/(N-1);
  const t=Array.from({length:N},(_,i)=>i*dt);
  const Ni=[], Nm=[], Np=[], Nc=[];
  for(const ti of t){
    const e1=Math.exp(lambda1*ti), e2=Math.exp(lambda2*ti);
    const ni=c1*e1 + c2*e2 + k1;
    const nm=c1*v12*e1 + c2*v22*e2 + k2;
    const nc=ni+nm, np=T-nc;
    Ni.push(Math.max(0,Math.min(T,ni)));
    Nm.push(Math.max(0,Math.min(T,nm)));
    Nc.push(Math.max(0,Math.min(T,nc)));
    Np.push(Math.max(0,Math.min(T,np)));
  }
  return {t,Ni,Nm,Np,Nc,k1,k2};
}

function makeTimePlot(c,e,m,d,Ni0,Nm0){
  const res=solveODE(c,e,m,d,Ni0,Nm0);
  const {t,Ni,Nm,Np,Nc,k1,k2}=res;
  const data=[
    {x:t,y:Ni,name:'N_I',line:{color:'#1b9e77',width:2}},
    {x:t,y:Nm,name:'N_M',line:{color:'#7570b3',width:2}},
    {x:t,y:Nc,name:'N_I+N_M',line:{color:'#d95f02',width:3,dash:'dash'}},
    {x:t,y:Np,name:'N_P',line:{color:'#e7298a',width:2,dash:'dot'}},
    {x:[t[0],t[t.length-1]],y:[k1,k1],mode:'lines',line:{color:'#1b9e77',dash:'dot'},showlegend:false},
    {x:[t[0],t[t.length-1]],y:[k2,k2],mode:'lines',line:{color:'#7570b3',dash:'dot'},showlegend:false}
  ];
  const layout={xaxis:{title:'time'},yaxis:{title:'Population fraction',range:[-0.05,1.05]},
                title:`Time series (c=${c.toFixed(2)}, e=${e.toFixed(2)}, m=${m.toFixed(2)}, d=${d.toFixed(2)})`,
                width:900,height:600,legend:{x:1.05}};
  Plotly.newPlot('time_plot',data,layout);
}

// ======== Update handler ==========
function update(){
  const c=parseFloat(c_in.value), e=parseFloat(e_in.value), m=parseFloat(m_in.value),
        d=parseFloat(d_in.value), Ni0=parseFloat(Ni0_in.value), Nm0=parseFloat(Nm0_in.value);
  document.getElementById('c_val').innerText=c;
  document.getElementById('e_val').innerText=e;
  document.getElementById('m_val').innerText=m;
  document.getElementById('d_val').innerText=d;
  document.getElementById('Ni0_val').innerText=Ni0;
  document.getElementById('Nm0_val').innerText=Nm0;
  makePhasePlot(c,e,m,d);
  makeTimePlot(c,e,m,d,Ni0,Nm0);
}

// ======== Bind sliders ==========
const c_in=document.getElementById('c'), e_in=document.getElementById('e'),
      m_in=document.getElementById('m'), d_in=document.getElementById('d'),
      Ni0_in=document.getElementById('Ni0'), Nm0_in=document.getElementById('Nm0');
[c_in,e_in,m_in,d_in,Ni0_in,Nm0_in].forEach(el=>el.addEventListener('input',update));

update();
</script>

</body>
</html>
